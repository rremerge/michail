AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  Calendar Agent Spike 1 (email intake -> calendar lookup -> response).
  Isolated stack only; does not modify global SES receipt rules or other applications.

Parameters:
  AppName:
    Type: String
    Default: calendar-agent-spike
  Stage:
    Type: String
    Default: dev
  CalendarMode:
    Type: String
    AllowedValues:
      - mock
      - google
      - connection
    Default: mock
  ResponseMode:
    Type: String
    AllowedValues:
      - log
      - send
    Default: log
  SenderEmail:
    Type: String
    Default: ""
    Description: Verified SES sender identity. Required if ResponseMode=send.
  HostTimezone:
    Type: String
    Default: America/Los_Angeles
  AdvisingDays:
    Type: String
    Default: Tue,Wed
  SearchDays:
    Type: Number
    Default: 120
  MaxSuggestions:
    Type: Number
    Default: 3
  WorkdayStartHour:
    Type: Number
    Default: 9
  WorkdayEndHour:
    Type: Number
    Default: 17
  DefaultDurationMinutes:
    Type: Number
    Default: 30
  MaxDurationMinutes:
    Type: Number
    Default: 120
  GoogleOAuthSecretName:
    Type: String
    Default: ""
    Description: Optional custom Secrets Manager name. Leave empty to auto-generate per stack.
  GoogleOAuthAppSecretName:
    Type: String
    Default: ""
    Description: Optional app-level secret name for Google OAuth client_id/client_secret.
  AdvisorId:
    Type: String
    Default: manoj
  LlmMode:
    Type: String
    AllowedValues:
      - disabled
      - openai
    Default: disabled
  IntentExtractionMode:
    Type: String
    AllowedValues:
      - parser
      - llm_hybrid
    Default: llm_hybrid
  IntentLlmTimeoutMs:
    Type: Number
    Default: 10000
  IntentLlmConfidenceThreshold:
    Type: Number
    Default: 0.65
  LlmTimeoutMs:
    Type: Number
    Default: 15000
  LlmProviderSecretName:
    Type: String
    Default: ""
    Description: Optional secret name for LLM provider settings.
  AdvisorPortalAuthMode:
    Type: String
    AllowedValues:
      - none
      - secret_basic
      - google_oauth
    Default: google_oauth
  AdvisorPortalAuthUsername:
    Type: String
    Default: manoj
  AdvisorPortalAuthSecretName:
    Type: String
    Default: ""
    Description: Optional secret name for advisor portal basic auth credentials.
  AdvisorPortalSessionSecretName:
    Type: String
    Default: ""
    Description: Optional secret name for advisor portal session signing key.
  AdvisorAllowedEmail:
    Type: String
    Default: ""
    Description: Optional advisor email allowlist entry for Google portal login.
  InboundRawEmailBucket:
    Type: String
    Default: ""
    Description: Optional S3 bucket containing transient raw inbound email MIME objects.
  InboundRawEmailBucketRegion:
    Type: String
    Default: ""
    Description: Region for the transient raw inbound email S3 bucket.
  InboundRawEmailObjectPrefix:
    Type: String
    Default: raw/
    Description: Prefix used for transient raw inbound email object keys.
  AvailabilityLinkTtlMinutes:
    Type: Number
    Default: 10080
    Description: Expiration for signed client availability links in minutes.
  AvailabilityLinkBaseUrl:
    Type: String
    Default: ""
    Description: Fully qualified public availability URL used in outbound emails.
  AvailabilityViewMaxSlots:
    Type: Number
    Default: 240
    Description: Maximum free slots rendered on the public availability page.
  ClientPolicyPresetsJson:
    Type: String
    Default: '{"default":["Tue","Wed"],"weekend":["Sat","Sun"],"monday":["Mon"]}'
    Description: JSON object mapping client policy IDs to allowed advising days.

Conditions:
  HasCustomSecretName: !Not [!Equals [!Ref GoogleOAuthSecretName, ""]]
  HasCustomAppSecretName: !Not [!Equals [!Ref GoogleOAuthAppSecretName, ""]]
  HasCustomLlmProviderSecretName: !Not [!Equals [!Ref LlmProviderSecretName, ""]]
  HasCustomAdvisorPortalAuthSecretName: !Not [!Equals [!Ref AdvisorPortalAuthSecretName, ""]]
  HasCustomAdvisorPortalSessionSecretName: !Not [!Equals [!Ref AdvisorPortalSessionSecretName, ""]]
  HasInboundRawEmailBucket: !Not [!Equals [!Ref InboundRawEmailBucket, ""]]

Resources:
  TraceTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: requestId
          AttributeType: S
      KeySchema:
        - AttributeName: requestId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  ConnectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: advisorId
          AttributeType: S
        - AttributeName: connectionId
          AttributeType: S
      KeySchema:
        - AttributeName: advisorId
          KeyType: HASH
        - AttributeName: connectionId
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  AvailabilityLinkTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tokenId
          AttributeType: S
      KeySchema:
        - AttributeName: tokenId
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  ClientProfilesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: advisorId
          AttributeType: S
        - AttributeName: clientId
          AttributeType: S
      KeySchema:
        - AttributeName: advisorId
          KeyType: HASH
        - AttributeName: clientId
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  PolicyPresetsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: advisorId
          AttributeType: S
        - AttributeName: policyId
          AttributeType: S
      KeySchema:
        - AttributeName: advisorId
          KeyType: HASH
        - AttributeName: policyId
          KeyType: RANGE
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  OAuthStateTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: state
          AttributeType: S
      KeySchema:
        - AttributeName: state
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true
      SSESpecification:
        SSEEnabled: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  GoogleOAuthSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !If
        - HasCustomSecretName
        - !Ref GoogleOAuthSecretName
        - !Sub /${AppName}/${Stage}/${AWS::StackName}/google-oauth
      Description: Google OAuth config for calendar free/busy lookup.
      SecretString: '{"client_id":"","client_secret":"","refresh_token":"","calendar_ids":["primary"]}'
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  GoogleOAuthAppSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !If
        - HasCustomAppSecretName
        - !Ref GoogleOAuthAppSecretName
        - !Sub /${AppName}/${Stage}/${AWS::StackName}/google-oauth-app
      Description: Google OAuth application credentials (client_id/client_secret).
      SecretString: '{"client_id":"","client_secret":""}'
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  LlmProviderSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !If
        - HasCustomLlmProviderSecretName
        - !Ref LlmProviderSecretName
        - !Sub /${AppName}/${Stage}/${AWS::StackName}/llm-provider
      Description: LLM provider configuration for response drafting.
      SecretString: '{"provider":"openai","api_key":"","model":"gpt-5.2","endpoint":"https://api.openai.com/v1/chat/completions"}'
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  AdvisorPortalAuthSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !If
        - HasCustomAdvisorPortalAuthSecretName
        - !Ref AdvisorPortalAuthSecretName
        - !Sub /${AppName}/${Stage}/${AWS::StackName}/advisor-portal-auth
      Description: Basic auth credentials for advisor portal access.
      GenerateSecretString:
        SecretStringTemplate: !Sub '{"username":"${AdvisorPortalAuthUsername}"}'
        GenerateStringKey: password
        PasswordLength: 24
        ExcludePunctuation: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  AdvisorPortalSessionSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !If
        - HasCustomAdvisorPortalSessionSecretName
        - !Ref AdvisorPortalSessionSecretName
        - !Sub /${AppName}/${Stage}/${AWS::StackName}/advisor-portal-session
      Description: Session signing key for advisor portal Google login.
      GenerateSecretString:
        SecretStringTemplate: "{}"
        GenerateStringKey: signing_key
        PasswordLength: 48
        ExcludePunctuation: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  AvailabilityLinkSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub /${AppName}/${Stage}/${AWS::StackName}/availability-link
      Description: Signing key for client-facing availability links.
      GenerateSecretString:
        SecretStringTemplate: "{}"
        GenerateStringKey: signing_key
        PasswordLength: 48
        ExcludePunctuation: true
      Tags:
        - Key: application
          Value: !Ref AppName
        - Key: stage
          Value: !Ref Stage

  SpikeApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: !Ref Stage
      CorsConfiguration:
        AllowMethods:
          - POST
          - GET
          - DELETE
          - PATCH
        AllowOrigins:
          - "*"
        AllowHeaders:
          - content-type
          - x-request-id

  EmailSpikeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: app/
      Handler: src/handler.handler
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 60
      Tracing: Active
      Environment:
        Variables:
          TRACE_TABLE_NAME: !Ref TraceTable
          GOOGLE_OAUTH_SECRET_ARN: !Ref GoogleOAuthSecret
          CONNECTIONS_TABLE_NAME: !Ref ConnectionsTable
          ADVISOR_ID: !Ref AdvisorId
          CALENDAR_MODE: !Ref CalendarMode
          RESPONSE_MODE: !Ref ResponseMode
          SENDER_EMAIL: !Ref SenderEmail
          HOST_TIMEZONE: !Ref HostTimezone
          ADVISING_DAYS: !Ref AdvisingDays
          SEARCH_DAYS: !Ref SearchDays
          MAX_SUGGESTIONS: !Ref MaxSuggestions
          WORKDAY_START_HOUR: !Ref WorkdayStartHour
          WORKDAY_END_HOUR: !Ref WorkdayEndHour
          DEFAULT_DURATION_MINUTES: !Ref DefaultDurationMinutes
          MAX_DURATION_MINUTES: !Ref MaxDurationMinutes
          LLM_MODE: !Ref LlmMode
          LLM_TIMEOUT_MS: !Ref LlmTimeoutMs
          INTENT_EXTRACTION_MODE: !Ref IntentExtractionMode
          INTENT_LLM_TIMEOUT_MS: !Ref IntentLlmTimeoutMs
          INTENT_LLM_CONFIDENCE_THRESHOLD: !Ref IntentLlmConfidenceThreshold
          LLM_PROVIDER_SECRET_ARN: !Ref LlmProviderSecret
          RAW_EMAIL_BUCKET: !Ref InboundRawEmailBucket
          RAW_EMAIL_BUCKET_REGION: !Ref InboundRawEmailBucketRegion
          RAW_EMAIL_OBJECT_PREFIX: !Ref InboundRawEmailObjectPrefix
          AVAILABILITY_LINK_BASE_URL: !Ref AvailabilityLinkBaseUrl
          AVAILABILITY_LINK_TABLE_NAME: !Ref AvailabilityLinkTable
          AVAILABILITY_LINK_TTL_MINUTES: !Ref AvailabilityLinkTtlMinutes
          CLIENT_PROFILES_TABLE_NAME: !Ref ClientProfilesTable
          POLICY_PRESETS_TABLE_NAME: !Ref PolicyPresetsTable
          CLIENT_POLICY_PRESETS_JSON: !Ref ClientPolicyPresetsJson
      Events:
        SpikeApiRequest:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: POST
            Path: /spike/email
        SpikeApiFeedback:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: POST
            Path: /spike/feedback
      Policies:
        - Statement:
            - Sid: WriteTraceMetadata
              Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:UpdateItem
              Resource: !GetAtt TraceTable.Arn
            - Sid: ReadConnections
              Effect: Allow
              Action:
                - dynamodb:Query
              Resource: !GetAtt ConnectionsTable.Arn
            - Sid: ReadGoogleOAuthSecret
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref GoogleOAuthSecret
            - Sid: ReadLlmProviderSecret
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref LlmProviderSecret
            - Sid: WriteAvailabilityLinks
              Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource: !GetAtt AvailabilityLinkTable.Arn
            - Sid: AccessClientProfiles
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt ClientProfilesTable.Arn
            - Sid: ReadPolicyPresets
              Effect: Allow
              Action:
                - dynamodb:Query
              Resource: !GetAtt PolicyPresetsTable.Arn
            - Sid: ReadConnectionOAuthSecrets
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AppName}/${Stage}/*
            - Sid: SendResponseEmail
              Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendRawEmail
              Resource: "*"
            - !If
              - HasInboundRawEmailBucket
              - Sid: AccessInboundRawEmailObjects
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:DeleteObject
                Resource: !Sub arn:aws:s3:::${InboundRawEmailBucket}/${InboundRawEmailObjectPrefix}*
              - !Ref AWS::NoValue
      Tags:
        application: !Ref AppName
        stage: !Ref Stage

  AdvisorPortalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: app/
      Handler: src/portal-handler.handler
      Runtime: nodejs22.x
      Architectures:
        - arm64
      MemorySize: 512
      Timeout: 60
      Tracing: Active
      Environment:
        Variables:
          APP_NAME: !Ref AppName
          STAGE: !Ref Stage
          ADVISOR_ID: !Ref AdvisorId
          CALENDAR_MODE: !Ref CalendarMode
          HOST_TIMEZONE: !Ref HostTimezone
          ADVISING_DAYS: !Ref AdvisingDays
          SEARCH_DAYS: !Ref SearchDays
          WORKDAY_START_HOUR: !Ref WorkdayStartHour
          WORKDAY_END_HOUR: !Ref WorkdayEndHour
          DEFAULT_DURATION_MINUTES: !Ref DefaultDurationMinutes
          MAX_DURATION_MINUTES: !Ref MaxDurationMinutes
          AVAILABILITY_LINK_SECRET_ARN: !Ref AvailabilityLinkSecret
          AVAILABILITY_LINK_TABLE_NAME: !Ref AvailabilityLinkTable
          AVAILABILITY_VIEW_MAX_SLOTS: !Ref AvailabilityViewMaxSlots
          CLIENT_PROFILES_TABLE_NAME: !Ref ClientProfilesTable
          POLICY_PRESETS_TABLE_NAME: !Ref PolicyPresetsTable
          CLIENT_POLICY_PRESETS_JSON: !Ref ClientPolicyPresetsJson
          GOOGLE_OAUTH_SECRET_ARN: !Ref GoogleOAuthSecret
          CONNECTIONS_TABLE_NAME: !Ref ConnectionsTable
          TRACE_TABLE_NAME: !Ref TraceTable
          OAUTH_STATE_TABLE_NAME: !Ref OAuthStateTable
          GOOGLE_OAUTH_APP_SECRET_ARN: !Ref GoogleOAuthAppSecret
          ADVISOR_PORTAL_AUTH_MODE: !Ref AdvisorPortalAuthMode
          ADVISOR_PORTAL_AUTH_SECRET_ARN: !Ref AdvisorPortalAuthSecret
          ADVISOR_PORTAL_SESSION_SECRET_ARN: !Ref AdvisorPortalSessionSecret
          ADVISOR_ALLOWED_EMAIL: !Ref AdvisorAllowedEmail
      Events:
        AdvisorAvailabilityPublic:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /availability
        AdvisorHome:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor
        AdvisorConnectionsList:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/api/connections
        AdvisorConnectionsMock:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: POST
            Path: /advisor/api/connections/mock
        AdvisorGoogleStart:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: POST
            Path: /advisor/api/connections/google/start
        AdvisorGoogleStartGet:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/api/connections/google/start
        AdvisorGoogleCallback:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/api/connections/google/callback
        AdvisorAuthGoogleStart:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/auth/google/start
        AdvisorAuthGoogleCallback:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/auth/google/callback
        AdvisorLogout:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: POST
            Path: /advisor/logout
        AdvisorConnectionsDelete:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: DELETE
            Path: /advisor/api/connections/{connectionId}
        AdvisorTraceLookup:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/api/traces/{requestId}
        AdvisorTraceFeedback:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: POST
            Path: /advisor/api/traces/{requestId}/feedback
        AdvisorClientsList:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/api/clients
        AdvisorClientsUpdate:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: PATCH
            Path: /advisor/api/clients/{clientId}
        AdvisorPoliciesList:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: GET
            Path: /advisor/api/policies
        AdvisorPoliciesCreate:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: POST
            Path: /advisor/api/policies
        AdvisorPoliciesUpdate:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: PATCH
            Path: /advisor/api/policies/{policyId}
        AdvisorPoliciesDelete:
          Type: HttpApi
          Properties:
            ApiId: !Ref SpikeApi
            Method: DELETE
            Path: /advisor/api/policies/{policyId}
      Policies:
        - Statement:
            - Sid: ManageConnections
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:DeleteItem
                - dynamodb:Query
              Resource: !GetAtt ConnectionsTable.Arn
            - Sid: ManageOauthState
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:DeleteItem
              Resource: !GetAtt OAuthStateTable.Arn
            - Sid: AccessTraceMetadata
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt TraceTable.Arn
            - Sid: ReadGoogleOAuthAppSecret
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref GoogleOAuthAppSecret
            - Sid: ReadGoogleOAuthSecret
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref GoogleOAuthSecret
            - Sid: ReadAdvisorPortalAuthSecret
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref AdvisorPortalAuthSecret
            - Sid: ReadAdvisorPortalSessionSecret
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref AdvisorPortalSessionSecret
            - Sid: ReadAvailabilityLinkSecret
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Ref AvailabilityLinkSecret
            - Sid: ReadConnectionOAuthSecrets
              Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AppName}/${Stage}/*
            - Sid: ReadAvailabilityLinks
              Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource: !GetAtt AvailabilityLinkTable.Arn
            - Sid: ManageClientProfiles
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:Query
                - dynamodb:UpdateItem
              Resource: !GetAtt ClientProfilesTable.Arn
            - Sid: ManagePolicyPresets
              Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:DeleteItem
                - dynamodb:Query
              Resource: !GetAtt PolicyPresetsTable.Arn
            - Sid: ManageConnectionSecrets
              Effect: Allow
              Action:
                - secretsmanager:CreateSecret
                - secretsmanager:DeleteSecret
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AppName}/${Stage}/*
      Tags:
        application: !Ref AppName
        stage: !Ref Stage

Outputs:
  SpikeApiUrl:
    Description: HTTP API endpoint for test email intake.
    Value: !Sub https://${SpikeApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/spike/email
  GoogleOAuthSecretArn:
    Description: Secret ARN for storing Google OAuth credentials.
    Value: !Ref GoogleOAuthSecret
  GoogleOAuthAppSecretArn:
    Description: Secret ARN for OAuth app credentials (client_id/client_secret).
    Value: !Ref GoogleOAuthAppSecret
  LlmProviderSecretArn:
    Description: Secret ARN for LLM provider credentials/settings.
    Value: !Ref LlmProviderSecret
  AdvisorPortalAuthSecretArn:
    Description: Secret ARN for advisor portal basic auth credentials.
    Value: !Ref AdvisorPortalAuthSecret
  AdvisorPortalSessionSecretArn:
    Description: Secret ARN for advisor portal session signing key.
    Value: !Ref AdvisorPortalSessionSecret
  AvailabilityLinkSecretArn:
    Description: Secret ARN for signing public availability links.
    Value: !Ref AvailabilityLinkSecret
  TraceTableName:
    Description: DynamoDB table for content-free request traces.
    Value: !Ref TraceTable
  ConnectionsTableName:
    Description: DynamoDB table for advisor calendar connections.
    Value: !Ref ConnectionsTable
  AvailabilityLinkTableName:
    Description: DynamoDB table for short-lived client availability links.
    Value: !Ref AvailabilityLinkTable
  ClientProfilesTableName:
    Description: DynamoDB table for advisor client profile metadata.
    Value: !Ref ClientProfilesTable
  PolicyPresetsTableName:
    Description: DynamoDB table for advisor-defined client policy presets.
    Value: !Ref PolicyPresetsTable
  AdvisorPortalUrl:
    Description: Advisor portal URL for managing connected calendars.
    Value: !Sub https://${SpikeApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/advisor
  AvailabilityUrl:
    Description: Public availability URL (requires signed token query parameter).
    Value: !Sub https://${SpikeApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/availability
